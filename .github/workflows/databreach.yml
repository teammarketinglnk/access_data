name: Daily BreachSense Scraper
permissions:
  contents: write
on:
  schedule:
    # Runs every day at 06:00 UTC (11:30 AM IST)
    - cron: "0 16 * * *"

  # Allows manual run from GitHub UI
  workflow_dispatch:

jobs:
  run-databreach:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # STEP 1: Checkout Repo
      # -----------------------------
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # REQUIRED to commit back changes

      # -----------------------------
      # STEP 2: Setup Python
      # -----------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -----------------------------
      # STEP 3: Install Dependencies
      # -----------------------------
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------
      # STEP 4: Run Scraper
      # -----------------------------
      - name: üöÄ Run BreachSense scraper
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python databreach.py

      # -----------------------------
      # STEP 5: Commit JSON Updates
      # -----------------------------
      - name: üíæ Commit updated JSON (if changed)
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git status

          git add breachsense_master.json breachsense_daily.json || true
          git commit -m "Update BreachSense data | $(date -u +'%Y-%m-%d')" || echo "No changes to commit"
          git push
